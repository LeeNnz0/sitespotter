<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Trip Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-1">Project Trip Tracker</h1>
            <p class="text-gray-500 text-sm">Track your projects with location, spotter, and trip details</p>
        </div>
        
        <!-- Add New Project Form -->
        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-6 border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Add New Project
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                    <input type="text" id="locationInput" placeholder="Enter location" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Spotter</label>
                    <input type="text" id="spotterInput" placeholder="Enter spotter name" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                    <input type="date" id="dateInput" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                    <input type="time" id="timeInput" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Number of Trips</label>
                    <div class="relative">
                        <select id="tripsSelect" onchange="handleTripsChange()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <option value="">Select trips</option>
                            <option value="1-pending">1 trip (Pending)</option>
                            <option value="2-pending">2 trips (Pending)</option>
                            <option value="3-pending">3 trips (Pending)</option>
                            <option value="4-pending">4 trips (Pending)</option>
                            <option value="5-pending">5 trips (Pending)</option>
                            <option value="6-pending">6 trips (Pending)</option>
                            <option value="7-pending">7 trips (Pending)</option>
                            <option value="8-pending">8 trips (Pending)</option>
                            <option value="9-pending">9 trips (Pending)</option>
                            <option value="10-pending">10 trips (Pending)</option>
                            <option value="15-pending">15 trips (Pending)</option>
                            <option value="20-pending">20 trips (Pending)</option>
                            <option value="custom-pending">Custom number (Pending)...</option>
                        </select>
                        <input type="number" id="customTripsInput" placeholder="Enter custom number" min="1" max="999" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 mt-2 hidden text-sm">
                    </div>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="addProject()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-4 rounded-md transition-colors text-sm">
                    Add Project
                </button>
                <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-md transition-colors text-sm">
                    Export Excel
                </button>
                <button onclick="generateShareableLink()" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2.5 px-4 rounded-md transition-colors text-sm">
                    Share Link
                </button>
            </div>
        </div>

        <!-- Projects List -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200">
            <div class="bg-gray-50 px-4 sm:px-6 py-4 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Project List</h2>
                    <div class="flex flex-wrap gap-2">
                        <span id="projectCount" class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded">0 projects</span>
                        <span id="pendingCount" class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-1 rounded">0 pending</span>
                        <span id="completedCount" class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded">0 completed</span>
                        <span id="totalTrips" class="bg-purple-100 text-purple-800 text-xs font-medium px-2 py-1 rounded">0 total trips</span>
                    </div>
                </div>
                
                <!-- Search Bar -->
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <input type="text" id="searchInput" placeholder="Search by location or spotter..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm"
                           oninput="filterProjects()">
                </div>
            </div>
            
            <!-- Desktop Table View -->
            <div class="hidden lg:block overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600">Location</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600">Spotter</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600">Date & Day</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600">Time</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600">Trips</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projectsList" class="bg-white divide-y divide-gray-200">
                        <!-- Projects will be added here dynamically -->
                    </tbody>
                </table>
            </div>
            
            <!-- Mobile Card View -->
            <div id="projectsListMobile" class="lg:hidden divide-y divide-gray-200">
                <!-- Mobile projects will be added here dynamically -->
            </div>
            
            <div id="emptyState" class="text-center py-12 sm:py-16 text-gray-500 px-4">
                <svg class="mx-auto h-12 sm:h-16 w-12 sm:w-16 text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-2">No projects yet</h3>
                <p class="text-sm sm:text-base text-gray-500">Add your first project using the form above!</p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-auto max-h-screen overflow-y-auto">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Edit Project</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                    <input type="text" id="editLocation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Spotter</label>
                    <input type="text" id="editSpotter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                    <input type="date" id="editDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                    <input type="time" id="editTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Number of Trips</label>
                    <div class="relative">
                        <select id="editTrips" onchange="handleEditTripsChange()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <option value="1-pending">1 trip (Pending)</option>
                            <option value="2-pending">2 trips (Pending)</option>
                            <option value="3-pending">3 trips (Pending)</option>
                            <option value="4-pending">4 trips (Pending)</option>
                            <option value="5-pending">5 trips (Pending)</option>
                            <option value="6-pending">6 trips (Pending)</option>
                            <option value="7-pending">7 trips (Pending)</option>
                            <option value="8-pending">8 trips (Pending)</option>
                            <option value="9-pending">9 trips (Pending)</option>
                            <option value="10-pending">10 trips (Pending)</option>
                            <option value="15-pending">15 trips (Pending)</option>
                            <option value="20-pending">20 trips (Pending)</option>
                            <option value="1-completed">1 trip (Completed)</option>
                            <option value="2-completed">2 trips (Completed)</option>
                            <option value="3-completed">3 trips (Completed)</option>
                            <option value="4-completed">4 trips (Completed)</option>
                            <option value="5-completed">5 trips (Completed)</option>
                            <option value="6-completed">6 trips (Completed)</option>
                            <option value="7-completed">7 trips (Completed)</option>
                            <option value="8-completed">8 trips (Completed)</option>
                            <option value="9-completed">9 trips (Completed)</option>
                            <option value="10-completed">10 trips (Completed)</option>
                            <option value="15-completed">15 trips (Completed)</option>
                            <option value="20-completed">20 trips (Completed)</option>
                            <option value="custom-pending">Custom number (Pending)...</option>
                            <option value="custom-completed">Custom number (Completed)...</option>
                        </select>
                        <input type="number" id="editCustomTripsInput" placeholder="Enter custom number" min="1" max="999" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 mt-2 hidden text-sm">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="saveEdit()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors text-sm">
                    Save Changes
                </button>
                <button onclick="closeEditModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 rounded-md transition-colors text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        let projects = [];
        let editingProjectId = null;

        // Load projects from localStorage and URL on page load
        function loadProjects() {
            // First try to load from URL (for shared links)
            const urlParams = new URLSearchParams(window.location.search);
            const urlData = urlParams.get('data');
            
            if (urlData) {
                try {
                    const decodedData = atob(urlData);
                    const sharedProjects = JSON.parse(decodedData);
                    
                    // Use the shared data exactly as is
                    projects = sharedProjects;
                    
                    // Save to localStorage for future use
                    localStorage.setItem('projectTripTracker', JSON.stringify(projects));
                    initializeFilteredProjects();
                    renderProjects();
                    
                    // Show notification that data was loaded from shared link
                    setTimeout(() => {
                        alert('Data loaded from shared link! You now have access to all the shared projects.');
                    }, 500);
                    return;
                } catch (e) {
                    console.log('Invalid URL data, loading from localStorage');
                }
            }
            
            // If no URL data, load from localStorage
            const saved = localStorage.getItem('projectTripTracker');
            if (saved) {
                projects = JSON.parse(saved);
            }
            initializeFilteredProjects();
            renderProjects();
        }

        // Save projects to localStorage
        function saveProjects() {
            localStorage.setItem('projectTripTracker', JSON.stringify(projects));
        }

        // Generate shareable link with data
        function generateShareableLink() {
            if (projects.length === 0) {
                alert('No projects to share');
                return;
            }
            
            const dataString = JSON.stringify(projects);
            const encodedData = btoa(dataString);
            const shareableUrl = `${window.location.origin}${window.location.pathname}?data=${encodedData}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareableUrl).then(() => {
                alert('Shareable link copied to clipboard! Anyone with this link can view your projects.');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareableUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Shareable link copied to clipboard! Anyone with this link can view your projects.');
            });
        }

        function getWeekday(dateString) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const date = new Date(dateString);
            return days[date.getDay()];
        }

        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function handleTripsChange() {
            const select = document.getElementById('tripsSelect');
            const customInput = document.getElementById('customTripsInput');
            
            if (select.value === 'custom-pending') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
                customInput.value = '';
            }
        }

        function handleEditTripsChange() {
            const select = document.getElementById('editTrips');
            const customInput = document.getElementById('editCustomTripsInput');
            
            if (select.value === 'custom-pending' || select.value === 'custom-completed') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
                customInput.value = '';
            }
        }

        function addProject() {
            const location = document.getElementById('locationInput').value.trim();
            const spotter = document.getElementById('spotterInput').value.trim();
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            const tripsSelect = document.getElementById('tripsSelect').value;
            const customTrips = document.getElementById('customTripsInput').value;

            let trips;
            if (tripsSelect === 'custom-pending') {
                if (!customTrips || customTrips < 1) {
                    alert('Please enter a valid custom number of trips');
                    return;
                }
                trips = { count: parseInt(customTrips), status: 'pending' };
            } else if (tripsSelect.includes('-')) {
                const [count, status] = tripsSelect.split('-');
                trips = { count: parseInt(count), status: status };
            } else {
                alert('Please select a valid trip option');
                return;
            }

            if (!location || !spotter || !date || !time || !tripsSelect) {
                alert('Please fill in all fields');
                return;
            }

            const project = {
                id: Date.now(),
                location: location,
                spotter: spotter,
                date: date,
                time: time,
                trips: trips
            };

            projects.push(project);
            saveProjects();
            initializeFilteredProjects();
            renderProjects();
            clearForm();
        }

        function editProject(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;

            editingProjectId = id;
            document.getElementById('editLocation').value = project.location;
            document.getElementById('editSpotter').value = project.spotter;
            document.getElementById('editDate').value = project.date;
            document.getElementById('editTime').value = project.time;
            
            // Check if the trips value exists in the dropdown options
            const editTripsSelect = document.getElementById('editTrips');
            const editCustomInput = document.getElementById('editCustomTripsInput');
            
            if (typeof project.trips === 'object') {
                const optionValue = `${project.trips.count}-${project.trips.status}`;
                const optionExists = Array.from(editTripsSelect.options).some(option => option.value === optionValue);
                
                if (optionExists) {
                    editTripsSelect.value = optionValue;
                    editCustomInput.classList.add('hidden');
                    editCustomInput.value = '';
                } else {
                    editTripsSelect.value = `custom-${project.trips.status}`;
                    editCustomInput.classList.remove('hidden');
                    editCustomInput.value = project.trips.count;
                }
            } else {
                // Handle old format (backward compatibility)
                if (project.trips === 'pending') {
                    editTripsSelect.value = '1-pending';
                } else {
                    editTripsSelect.value = `${project.trips}-completed`;
                }
                editCustomInput.classList.add('hidden');
                editCustomInput.value = '';
            }
            
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        function saveEdit() {
            const project = projects.find(p => p.id === editingProjectId);
            if (!project) return;

            const location = document.getElementById('editLocation').value.trim();
            const spotter = document.getElementById('editSpotter').value.trim();
            const date = document.getElementById('editDate').value;
            const time = document.getElementById('editTime').value;
            const tripsSelect = document.getElementById('editTrips').value;
            const customTrips = document.getElementById('editCustomTripsInput').value;

            let trips;
            if (tripsSelect === 'custom-pending' || tripsSelect === 'custom-completed') {
                if (!customTrips || customTrips < 1) {
                    alert('Please enter a valid custom number of trips');
                    return;
                }
                const status = tripsSelect.split('-')[1];
                trips = { count: parseInt(customTrips), status: status };
            } else if (tripsSelect.includes('-')) {
                const [count, status] = tripsSelect.split('-');
                trips = { count: parseInt(count), status: status };
            } else {
                alert('Please select a valid trip option');
                return;
            }

            if (!location || !spotter || !date || !time || !tripsSelect) {
                alert('Please fill in all fields');
                return;
            }

            project.location = location;
            project.spotter = spotter;
            project.date = date;
            project.time = time;
            project.trips = trips;

            saveProjects();
            initializeFilteredProjects();
            renderProjects();
            closeEditModal();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
            editingProjectId = null;
        }

        function markAsComplete(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            
            if (typeof project.trips === 'object' && project.trips.status === 'pending') {
                project.trips.status = 'completed';
                saveProjects();
                initializeFilteredProjects();
                renderProjects();
            }
        }

        function markAsPending(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            
            if (confirm('Mark this project as pending? This will remove the trip count.')) {
                project.trips = 'pending';
                saveProjects();
                renderProjects();
            }
        }

        function deleteProject(id) {
            if (confirm('Are you sure you want to delete this project?')) {
                projects = projects.filter(project => project.id !== id);
                saveProjects();
                initializeFilteredProjects();
                renderProjects();
            }
        }

        function exportToExcel() {
            if (projects.length === 0) {
                alert('No projects to export');
                return;
            }

            const exportData = projects.map(project => ({
                'Location': project.location,
                'Spotter': project.spotter,
                'Date': new Date(project.date).toLocaleDateString(),
                'Weekday': getWeekday(project.date),
                'Time': formatTime(project.time),
                'Number of Trips': typeof project.trips === 'object' ? project.trips.count : project.trips,
                'Status': typeof project.trips === 'object' ? 
                    (project.trips.status === 'pending' ? 'Pending' : 'Completed') : 
                    (project.trips === 'pending' ? 'Pending' : 'Completed')
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Projects');
            
            const fileName = `Project_Trip_Tracker_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        let filteredProjects = [];

        function filterProjects() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredProjects = [...projects];
            } else {
                filteredProjects = projects.filter(project => 
                    project.location.toLowerCase().includes(searchTerm) ||
                    project.spotter.toLowerCase().includes(searchTerm)
                );
            }
            
            renderProjects();
        }

        function renderProjects() {
            const projectsList = document.getElementById('projectsList');
            const projectsListMobile = document.getElementById('projectsListMobile');
            const emptyState = document.getElementById('emptyState');
            const projectCount = document.getElementById('projectCount');
            const pendingCount = document.getElementById('pendingCount');
            const completedCount = document.getElementById('completedCount');
            const totalTrips = document.getElementById('totalTrips');

            // Use filtered projects if search is active, otherwise use all projects
            const projectsToShow = filteredProjects.length > 0 || document.getElementById('searchInput').value.trim() !== '' ? filteredProjects : projects;

            // Calculate counts
            const pendingProjectsCount = projects.filter(project => 
                typeof project.trips === 'object' && project.trips.status === 'pending'
            ).length;
            
            const completedProjectsCount = projects.filter(project => 
                typeof project.trips === 'object' && project.trips.status === 'completed'
            ).length;

            const totalTripsCount = projects.reduce((sum, project) => {
                if (typeof project.trips === 'object') {
                    return sum + (project.trips.status === 'completed' ? project.trips.count : 0);
                } else {
                    // Handle old format (backward compatibility)
                    return sum + (project.trips === 'pending' ? 0 : project.trips);
                }
            }, 0);

            projectCount.textContent = `${projects.length} project${projects.length !== 1 ? 's' : ''}`;
            pendingCount.textContent = `${pendingProjectsCount} pending`;
            completedCount.textContent = `${completedProjectsCount} completed`;
            totalTrips.textContent = `${totalTripsCount} total trip${totalTripsCount !== 1 ? 's' : ''}`;

            if (projectsToShow.length === 0) {
                projectsList.innerHTML = '';
                projectsListMobile.innerHTML = '';
                emptyState.style.display = 'block';
                if (document.getElementById('searchInput').value.trim() !== '') {
                    emptyState.innerHTML = `
                        <svg class="mx-auto h-12 sm:h-16 w-12 sm:w-16 text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-2">No projects found</h3>
                        <p class="text-sm sm:text-base text-gray-500">Try searching with different keywords</p>
                    `;
                } else {
                    emptyState.innerHTML = `
                        <svg class="mx-auto h-12 sm:h-16 w-12 sm:w-16 text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-2">No projects yet</h3>
                        <p class="text-sm sm:text-base text-gray-500">Add your first project using the form above!</p>
                    `;
                }
                return;
            }

            emptyState.style.display = 'none';
            
            // Sort projects: pending first (by date newest first), then completed (by date newest first)
            const sortedProjects = [...projectsToShow].sort((a, b) => {
                const aStatus = typeof a.trips === 'object' ? a.trips.status : 'completed';
                const bStatus = typeof b.trips === 'object' ? b.trips.status : 'completed';
                
                // If one is pending and other is completed, pending comes first
                if (aStatus === 'pending' && bStatus === 'completed') return -1;
                if (aStatus === 'completed' && bStatus === 'pending') return 1;
                
                // If both have same status, sort by date (newest first)
                return new Date(b.date) - new Date(a.date);
            });
            
            // Desktop table view
            projectsList.innerHTML = sortedProjects.map(project => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${project.location}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${project.spotter}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${new Date(project.date).toLocaleDateString()}</div>
                        <div class="text-xs text-blue-600 font-medium">${getWeekday(project.date)}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${formatTime(project.time)}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                ${typeof project.trips === 'object' ? project.trips.count : project.trips} trip${(typeof project.trips === 'object' ? project.trips.count : project.trips) !== 1 ? 's' : ''}
                            </span>
                            ${typeof project.trips === 'object' && project.trips.status === 'pending' ? 
                                '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>' :
                                typeof project.trips === 'object' && project.trips.status === 'completed' ?
                                '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">Completed</span>' :
                                ''
                            }
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                        <div class="flex gap-2 flex-wrap">
                            ${typeof project.trips === 'object' && project.trips.status === 'pending' ? 
                                `<button onclick="markAsComplete(${project.id})" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs transition-colors">
                                    Complete
                                </button>` :
                                ''
                            }
                            <button onclick="editProject(${project.id})" class="text-blue-600 hover:text-blue-900 transition-colors text-xs">
                                Edit
                            </button>
                            <button onclick="deleteProject(${project.id})" class="text-red-600 hover:text-red-900 transition-colors text-xs">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Mobile card view
            projectsListMobile.innerHTML = sortedProjects.map(project => `
                <div class="p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900 text-sm">${project.location}</h3>
                            <p class="text-sm text-gray-600 mt-1">by ${project.spotter}</p>
                        </div>
                        <div class="flex items-center gap-2 ml-3">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${typeof project.trips === 'object' ? project.trips.count : project.trips} trip${(typeof project.trips === 'object' ? project.trips.count : project.trips) !== 1 ? 's' : ''}
                            </span>
                            ${typeof project.trips === 'object' && project.trips.status === 'pending' ? 
                                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>' :
                                typeof project.trips === 'object' && project.trips.status === 'completed' ?
                                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Completed</span>' :
                                ''
                            }
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-3 text-sm">
                        <div>
                            <span class="text-gray-500">Date:</span>
                            <div class="font-medium text-gray-900">${new Date(project.date).toLocaleDateString()}</div>
                            <div class="text-xs text-blue-600 font-medium">${getWeekday(project.date)}</div>
                        </div>
                        <div>
                            <span class="text-gray-500">Time:</span>
                            <div class="font-medium text-gray-900">${formatTime(project.time)}</div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        ${typeof project.trips === 'object' && project.trips.status === 'pending' ? 
                            `<button onclick="markAsComplete(${project.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg transition-colors flex items-center text-xs">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Complete
                            </button>` :
                            ''
                        }
                        <button onclick="editProject(${project.id})" class="text-blue-600 hover:text-blue-900 transition-colors flex items-center px-2 py-1.5 text-xs">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Edit
                        </button>
                        <button onclick="deleteProject(${project.id})" class="text-red-600 hover:text-red-900 transition-colors flex items-center px-2 py-1.5 text-xs">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function clearForm() {
            document.getElementById('locationInput').value = '';
            document.getElementById('spotterInput').value = '';
            document.getElementById('dateInput').value = '';
            document.getElementById('timeInput').value = '';
            document.getElementById('tripsSelect').value = '';
            document.getElementById('customTripsInput').value = '';
            document.getElementById('customTripsInput').classList.add('hidden');
        }

        // Initialize filtered projects
        function initializeFilteredProjects() {
            filteredProjects = [...projects];
        }

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Load projects when page loads
        window.addEventListener('load', loadProjects);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96f83ef40132e63e',t:'MTc1NTI1NjIzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
